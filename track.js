
!function(){function n(){const n=document.getElementsByTagName("script");for(let t of n)if(t.src&&t.src.includes("track.js"))try{const n=new URL(t.src,window.location.origin).searchParams.get("ga_id");if(n)return n}catch(n){}return null}const t=n();window.dataLayer=window.dataLayer||[];var e=window.tjHub||{};e.queue=e.queue||[];const a="https://tj-track-bd.tj-studio-ltda.workers.dev/get-tracking-data";function i(){return"undefined"!=typeof gtag}function o(n,a){if(i())try{console.log("[TJHub][GA4] Tentando enviar evento:",n,a),gtag("event",n,{...a,send_to:t||"all",non_interaction:"scroll"===n||"vertical_scroll"===n}),console.log("[TJHub][GA4] Evento enviado para o gtag:",n)}catch(t){console.error("[TJHub][GA4] Erro ao enviar evento:",n,t)}else console.warn("[TJHub][GA4] gtag não está disponível no momento do envio:",n)}function r(){const n=window.innerWidth;return n<=768?"mobile":n<=1024?"tablet":"desktop"}e.site_id=function(){const n=document.getElementsByTagName("script");for(let t of n)if(t.src.includes("site_id="))try{return new URL(t.src).searchParams.get("site_id")}catch(n){}return"TJTJS2025"}(),e.session_id=localStorage.getItem("tj_session_id")||`sess_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("tj_session_id",e.session_id);const c={get:n=>{const t=`; ${document.cookie}`.split(`; ${n}=`);return 2===t.length?t.pop().split(";").shift():null},getGaId:function(){const n=this.get("_ga");return n?n.replace(/^GA1\.\d\./," "):null},getGaSession:function(){const n=document.cookie.split(";");for(let t of n)if(t.trim().startsWith("_ga_")&&t.split(".").length>2)return t.split(".")[2];return null}};function d(){return{utm_source:localStorage.getItem("tj_utm_source"),utm_medium:localStorage.getItem("tj_utm_medium"),utm_campaign:localStorage.getItem("tj_utm_campaign"),utm_content:localStorage.getItem("tj_utm_content"),utm_term:localStorage.getItem("tj_utm_term"),gclid:localStorage.getItem("tj_gclid"),fbclid:localStorage.getItem("tj_fbclid"),ga_client_id:c.getGaId(),ga_session_id:c.getGaSession(),fbp:c.get("_fbp"),fbc:c.get("_fbc")}}!function(){const n=new URLSearchParams(window.location.search);["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid"].forEach(t=>{n.has(t)&&localStorage.setItem("tj_"+t,n.get(t))})}();let l=0,s=!1,u=0,m=null,g=null;window.addEventListener("scroll",function(){const n=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)-window.innerHeight,t=n>0?Math.round(window.scrollY/n*100):0;if(t>l){l=t;const n=10*Math.floor(t/10);if(n>u){u=n,g={scroll_y:window.scrollY,scroll_depth:n,max_scroll_depth:l,screen_size:`${window.innerWidth}x${window.innerHeight}`,session_id:e.session_id,page_path:window.location.pathname,device_category:r()},m&&(clearTimeout(m),m=null),"visible"===document.visibilityState&&(m=setTimeout(function(){g&&(console.log("[TJHub] vertical_scroll event (foco)",g),e.track("vertical_scroll",g),o("vertical_scroll",{scroll_depth:g.scroll_depth,page_path:g.page_path,device_category:g.device_category}),g=null)},5e3))}}document.addEventListener("visibilitychange",function(){"visible"!==document.visibilityState&&m&&(clearTimeout(m),m=null,g=null),"visible"===document.visibilityState&&g&&(m=setTimeout(function(){g&&(console.log("[TJHub] vertical_scroll event (foco)",g),e.track("vertical_scroll",g),o("vertical_scroll",{scroll_depth:g.scroll_depth,page_path:g.page_path,device_category:g.device_category}),g=null)},5e3))})},{passive:!0});function f(){if(!s&&l>0){const n={max_scroll_depth:l,page_path:window.location.pathname,device_category:r()};e.track("scroll_depth_max",n),o("scroll_depth",{max_scroll_depth:l,page_path:window.location.pathname,device_category:r()}),s=!0}}document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&f()}),window.addEventListener("pagehide",f);function h(){if(e.sending){clearTimeout(e.sending),e.sending=null}if(e.queue.length>0){let n=e.queue.slice();e.queue=[];const t=JSON.stringify({events:n}),i=`${a}?site_id=${e.site_id}`;navigator.sendBeacon?navigator.sendBeacon(i,t):fetch(i,{method:"POST",body:t,keepalive:!1})}}window.addEventListener("pagehide",h),e.track=function(n,t={}){t.url=window.location.href,t.referrer=document.referrer,t.session_id=e.session_id,t.site_id=e.site_id,t.screen_size=`${window.innerWidth}x${window.innerHeight}`,t.device=navigator.userAgent,t.device_category=r(),t.timestamp=new Date().toISOString(),e.queue.push({event:n,data:t}),e.sending||(e.sending=setTimeout(h,5e3))},e.track("page_view"),o("page_view",{page_path:window.location.pathname,page_title:document.title,device_category:r()}),document.addEventListener("click",function(n){const t=n.pageX,i=n.pageY,a=window.innerWidth,o=window.innerHeight,r=Math.round(n.clientX/a*100),c=Math.round(n.clientY/o*100),d=n.target.closest("a, button");if(!d){const a={click_x:t,click_y:i,click_x_percent:r,click_y_percent:c,page_path:window.location.pathname,target:n.target.tagName.toLowerCase(),class:n.target.className||"",id:n.target.id||"",device_category:r()};return e.track("heatmap_click",a),void o("heatmap_click",{click_x:t,click_y:i,page_path:window.location.pathname,element_id:n.target.id||"(not set)",element_class:n.target.className||"(not set)",device_category:r()})}let s={target:d.tagName.toLowerCase(),text:d.innerText?d.innerText.substring(0,50):"",class:d.className||"",id:d.id||"",href:d.href||"",click_x:t,click_y:i,click_x_percent:r,click_y_percent:c,page_path:window.location.pathname,device_category:r()};"a"===d.tagName.toLowerCase()&&d.hostname!==window.location.hostname?(s.external=!0,e.track("click_outbound",s),navigator.sendBeacon(`${a}?site_id=${e.site_id}`,JSON.stringify({events:[{event:"click_outbound",data:s}]})),o("click_outbound",{click_x:t,click_y:i,link_url:d.href,link_text:s.text,page_path:window.location.pathname,device_category:r()})):(e.track("click",s),o("click",{click_x:t,click_y:i,element_id:s.id||"(not set)",element_text:s.text,page_path:window.location.pathname,device_category:r()}))}),document.addEventListener("submit",function(n){const t=n.target;if(!t||"form"!==t.tagName.toLowerCase())return;if("true"!==t.getAttribute("data-track"))return;let i=new FormData(t),a={},o={nome:null,email:null,tel:null};for(let[e,r]of i.entries())if("string"==typeof e&&!e.toLowerCase().includes("senha")){a[e]=r;let n=e.toLowerCase();o.nome||!n.includes("nome")&&!n.includes("name")?!o.email&&n.includes("mail")?o.email=r:!o.tel&&(n.includes("tel")||n.includes("cel")||n.includes("whats"))&&(o.tel=r):o.nome=r}const c={tag:t.getAttribute("data-tag")||"Form Site",action:t.action||"",method:t.method||"GET",form_id:t.id||"",form_class:t.className||"",fields:a,lead_info:o,marketing:d(),page_path:window.location.pathname,device_category:r()};e.track("form_submit",c),o("form_submit",{form_id:c.form_id||"(not set)",form_destination:c.action,page_path:window.location.pathname,device_category:r()})},window.tjHub=e,console.log("✅ TJ Track Enhanced with GA4 Heatmap initialized",{site_id:e.site_id,session_id:e.session_id,ga4_available:i()})}();
