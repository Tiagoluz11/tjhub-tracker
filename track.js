!function(){var t=window.tjHub||{};t.dataLayer=window.dataLayer=window.dataLayer||[];const e="https://tj-track-bd.tj-studio-ltda.workers.dev/get-tracking-data";function isGA4Available(){return"undefined"!=typeof gtag}function sendToGA4(t,e){if(isGA4Available())try{gtag("event",t,{...e,send_to:"all",non_interaction:"scroll"===t||"vertical_scroll"===t})}catch(t){console.warn("GA4 tracking error:",t)}}function getDeviceCategory(){const t=window.innerWidth;return t<=768?"mobile":t<=1024?"tablet":"desktop"}function n(){const t=document.getElementsByTagName("script");for(let e of t)if(e.src.includes("site_id="))try{return new URL(e.src).searchParams.get("site_id")}catch(t){}return"TJTJS2025"}t.site_id=n(),t.session_id=localStorage.getItem("tj_session_id")||`sess_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("tj_session_id",t.session_id);const a={get:t=>{const e=`; ${document.cookie}`.split(`; ${t}=`);return 2===e.length?e.pop().split(";").shift():null},getGaId:function(){const t=this.get("_ga");return t?t.replace(/^GA1\.\d\./,""):null},getGaSession:function(){const t=document.cookie.split(";");for(let e of t)if(e.trim().startsWith("_ga_")&&e.split(".").length>2)return e.split(".")[2];return null}};function o(){const t=new URLSearchParams(window.location.search);["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid"].forEach(e=>{t.has(e)&&localStorage.setItem("tj_"+e,t.get(e))})}function i(){return{utm_source:localStorage.getItem("tj_utm_source"),utm_medium:localStorage.getItem("tj_utm_medium"),utm_campaign:localStorage.getItem("tj_utm_campaign"),utm_content:localStorage.getItem("tj_utm_content"),utm_term:localStorage.getItem("tj_utm_term"),gclid:localStorage.getItem("tj_gclid"),fbclid:localStorage.getItem("tj_fbclid"),ga_client_id:a.getGaId(),ga_session_id:a.getGaSession(),fbp:a.get("_fbp"),fbc:a.get("_fbc")}}o();let r,s=0,maxScrollDepth=0;window.addEventListener("scroll",function(){s=window.scrollY;const n=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)-window.innerHeight,a=n>0?Math.round(s/n*100):0;a>maxScrollDepth&&(maxScrollDepth=a),clearTimeout(r),r=setTimeout(()=>{const n={scroll_y:s,scroll_depth:a,max_scroll_depth:maxScrollDepth,screen_size:`${window.innerWidth}x${window.innerHeight}`,session_id:t.session_id,page_path:window.location.pathname,device_category:getDeviceCategory()};t.track("vertical_scroll",n),sendToGA4("scroll",{scroll_depth:a,page_path:window.location.pathname,device_category:getDeviceCategory()})},3e3)}),t.track=function(n,a={}){a.url=window.location.href,a.referrer=document.referrer,a.session_id=t.session_id,a.site_id=t.site_id,a.screen_size=`${window.innerWidth}x${window.innerHeight}`,a.device=navigator.userAgent,a.device_category=getDeviceCategory(),a.timestamp=(new Date).toISOString(),t.dataLayer.push({event:n,data:a}),t.sending||(t.sending=setTimeout(()=>{let n=t.dataLayer.slice();t.dataLayer=[];const a=JSON.stringify({events:n});navigator.sendBeacon?navigator.sendBeacon(`${e}?site_id=${t.site_id}`,a):fetch(`${e}?site_id=${t.site_id}`,{method:"POST",body:a}),t.sending=null},5e3))},t.track("page_view"),sendToGA4("page_view",{page_path:window.location.pathname,page_title:document.title,device_category:getDeviceCategory()}),document.addEventListener("click",function(n){const a=n.pageX,o=n.pageY,r=window.innerWidth,s=window.innerHeight,i=Math.round(n.clientX/r*100),c=Math.round(n.clientY/s*100),l=n.target.closest("a, button");if(!l){const e={click_x:a,click_y:o,click_x_percent:i,click_y_percent:c,page_path:window.location.pathname,target:n.target.tagName.toLowerCase(),class:n.target.className||"",id:n.target.id||"",device_category:getDeviceCategory()};return t.track("heatmap_click",e),void sendToGA4("heatmap_click",{click_x:a,click_y:o,page_path:window.location.pathname,element_id:n.target.id||"(not set)",element_class:n.target.className||"(not set)",device_category:getDeviceCategory()})}let d={target:l.tagName.toLowerCase(),text:l.innerText?l.innerText.substring(0,50):"",class:l.className||"",id:l.id||"",href:l.href||"",click_x:a,click_y:o,click_x_percent:i,click_y_percent:c,page_path:window.location.pathname,device_category:getDeviceCategory()};if("a"===l.tagName.toLowerCase()&&l.hostname!==window.location.hostname){d.external=!0,t.track("click_outbound",d),navigator.sendBeacon(`${e}?site_id=${t.site_id}`,JSON.stringify({events:[{event:"click_outbound",data:d}]})),sendToGA4("click_outbound",{click_x:a,click_y:o,link_url:l.href,link_text:d.text,page_path:window.location.pathname,device_category:getDeviceCategory()})}else t.track("click",d),sendToGA4("click",{click_x:a,click_y:o,element_id:d.id||"(not set)",element_text:d.text,page_path:window.location.pathname,device_category:getDeviceCategory()})}),document.addEventListener("submit",function(e){const n=e.target;if(!n||"form"!==n.tagName.toLowerCase())return;if("true"!==n.getAttribute("data-track"))return;let a=new FormData(n),o={},r={nome:null,email:null,tel:null};for(let[t,e]of a.entries())if("string"==typeof t&&!t.toLowerCase().includes("senha")){o[t]=e;let n=t.toLowerCase();!r.nome&&(n.includes("nome")||n.includes("name"))?r.nome=e:!r.email&&n.includes("mail")?r.email=e:!r.tel&&(n.includes("tel")||n.includes("cel")||n.includes("whats"))&&(r.tel=e)}const s={tag:n.getAttribute("data-tag")||"Form Site",action:n.action||"",method:n.method||"GET",form_id:n.id||"",form_class:n.className||"",fields:o,lead_info:r,marketing:i(),page_path:window.location.pathname,device_category:getDeviceCategory()};t.track("form_submit",s),sendToGA4("form_submit",{form_id:s.form_id||"(not set)",form_destination:s.action,page_path:window.location.pathname,device_category:getDeviceCategory()})});let scrollCompletionSent=!1;window.addEventListener("scroll",function(){if(scrollCompletionSent)return;const e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight)-window.innerHeight,n=window.scrollY,a=e>0?n/e*100:0;a>=90&&(scrollCompletionSent=!0,t.track("scroll_completion",{scroll_depth:90,page_path:window.location.pathname,device_category:getDeviceCategory()}),sendToGA4("scroll_completion",{scroll_depth:90,page_path:window.location.pathname,device_category:getDeviceCategory()}))}),window.tjHub=t,console.log("âœ… TJ Track Enhanced with GA4 Heatmap initialized",{site_id:t.site_id,session_id:t.session_id,ga4_available:isGA4Available()})}();
