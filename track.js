function getGaMeasurementId(){const e=document.getElementsByTagName("script");for(let t of e)if(t.src&&t.src.includes("track.js"))try{const e=new URL(t.src,window.location.origin).searchParams.get("ga_id");if(e)return e}catch(e){}return null}const gaMeasurementId=getGaMeasurementId();!function(){window.dataLayer=window.dataLayer||[];var e=window.tjHub||{};e.queue=e.queue||[];const t="https://tj-track-bd.tj-studio-ltda.workers.dev/get-tracking-data";function n(){return"undefined"!=typeof gtag}function i(e,t){if(n())try{console.log("[TJHub][GA4] Tentando enviar evento:",e,t),gtag("event",e,{...t,send_to:gaMeasurementId||"all",non_interaction:"scroll"===e||"vertical_scroll"===e}),console.log("[TJHub][GA4] Evento enviado para o gtag:",e)}catch(t){console.error("[TJHub][GA4] Erro ao enviar evento:",e,t)}else console.warn("[TJHub][GA4] gtag não está disponível no momento do envio:",e)}function o(){const e=window.innerWidth;return e<=768?"mobile":e<=1024?"tablet":"desktop"}e.site_id=function(){const e=document.getElementsByTagName("script");for(let t of e)if(t.src.includes("site_id="))try{return new URL(t.src).searchParams.get("site_id")}catch(e){}return"TJTJS2025"}(),e.session_id=localStorage.getItem("tj_session_id")||`sess_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("tj_session_id",e.session_id);const a={get:e=>{const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null},getGaId:function(){const e=this.get("_ga");return e?e.replace(/^GA1\.\d\./,""):null},getGaSession:function(){const e=document.cookie.split(";");for(let t of e)if(t.trim().startsWith("_ga_")&&t.split(".").length>2)return t.split(".")[2];return null}};!function(){const e=new URLSearchParams(window.location.search);["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid"].forEach((t=>{e.has(t)&&localStorage.setItem("tj_"+t,e.get(t))}))}();let c=0,l=!1,s=0,r=null,d=null;function _(){if(!l){if(c>0){const t={max_scroll_depth:c,page_path:window.location.pathname,device_category:o()};e.track("scroll_depth_max",t),i("scroll_depth",{max_scroll_depth:c,page_path:window.location.pathname,device_category:o()})}l=!0}}function u(){if(e.sending&&(clearTimeout(e.sending),e.sending=null),e.queue.length>0){let n=e.queue.slice();e.queue=[];const i=JSON.stringify({events:n}),o=`${t}?site_id=${e.site_id}`;navigator.sendBeacon?navigator.sendBeacon(o,i):fetch(o,{method:"POST",body:i,keepalive:!1})}}window.addEventListener("scroll",(function(){const t=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)-window.innerHeight,n=t>0?Math.round(window.scrollY/t*100):0;if(n>c){c=n;const t=10*Math.floor(n/10);t>s&&(s=t,d={scroll_y:window.scrollY,scroll_depth:t,max_scroll_depth:c,screen_size:`${window.innerWidth}x${window.innerHeight}`,session_id:e.session_id,page_path:window.location.pathname,device_category:o()},r&&(clearTimeout(r),r=null),"visible"===document.visibilityState&&(r=setTimeout((function(){d&&(console.log("[TJHub] vertical_scroll event (foco)",d),e.track("vertical_scroll",d),i("vertical_scroll",{scroll_depth:d.scroll_depth,page_path:d.page_path,device_category:d.device_category}),d=null)}),5e3)))}document.addEventListener("visibilitychange",(function(){"visible"!==document.visibilityState&&r&&(clearTimeout(r),r=null,d=null),"visible"===document.visibilityState&&d&&(r=setTimeout((function(){d&&(console.log("[TJHub] vertical_scroll event (foco)",d),e.track("vertical_scroll",d),i("vertical_scroll",{scroll_depth:d.scroll_depth,page_path:d.page_path,device_category:d.device_category}),d=null)}),5e3))}))}),{passive:!0}),document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&_()})),window.addEventListener("pagehide",_),window.addEventListener("pagehide",u),e.track=function(t,n={}){n.url=window.location.href,n.referrer=document.referrer,n.session_id=e.session_id,n.site_id=e.site_id,n.screen_size=`${window.innerWidth}x${window.innerHeight}`,n.device=navigator.userAgent,n.device_category=o(),n.timestamp=(new Date).toISOString(),e.queue.push({event:t,data:n}),e.sending||(e.sending=setTimeout(u,5e3))},e.track("page_view"),i("page_view",{page_path:window.location.pathname,page_title:document.title,device_category:o()}),document.addEventListener("click",(function(n){const a=n.pageX,c=n.pageY,l=window.innerWidth,s=window.innerHeight,r=Math.round(n.clientX/l*100),d=Math.round(n.clientY/s*100),_=n.target.closest("a, button");if(!_){const t={click_x:a,click_y:c,click_x_percent:r,click_y_percent:d,page_path:window.location.pathname,target:n.target.tagName.toLowerCase(),class:n.target.className||"",id:n.target.id||"",device_category:o()};return e.track("heatmap_click",t),void i("heatmap_click",{click_x:a,click_y:c,page_path:window.location.pathname,element_id:n.target.id||"(not set)",element_class:n.target.className||"(not set)",device_category:o()})}let u={target:_.tagName.toLowerCase(),text:_.innerText?_.innerText.substring(0,50):"",class:_.className||"",id:_.id||"",href:_.href||"",click_x:a,click_y:c,click_x_percent:r,click_y_percent:d,page_path:window.location.pathname,device_category:o()};if("a"===_.tagName.toLowerCase()&&_.hostname!==window.location.hostname){u.external=!0,e.track("click_outbound",u);const n=`${t}?site_id=${e.site_id}`,l=JSON.stringify({events:[{event:"click_outbound",data:u}]});navigator.sendBeacon(n,l),i("click_outbound",{click_x:a,click_y:c,link_url:_.href,link_text:u.text,page_path:window.location.pathname,device_category:o()})}else e.track("click",u),i("click",{click_x:a,click_y:c,element_id:u.id||"(not set)",element_text:u.text,page_path:window.location.pathname,device_category:o()})})),document.addEventListener("submit",(function(t){const n=t.target;if(!n||"form"!==n.tagName.toLowerCase())return;if("true"!==n.getAttribute("data-track"))return;let c=new FormData(n),l={},s={nome:null,email:null,tel:null};for(let[e,t]of c.entries())if("string"==typeof e&&!e.toLowerCase().includes("senha")){l[e]=t;let n=e.toLowerCase();s.nome||!n.includes("nome")&&!n.includes("name")?!s.email&&n.includes("mail")?s.email=t:!s.tel&&(n.includes("tel")||n.includes("cel")||n.includes("whats"))&&(s.tel=t):s.nome=t}const r={tag:n.getAttribute("data-tag")||"Form Site",action:n.action||"",method:n.method||"GET",form_id:n.id||"",form_class:n.className||"",fields:l,lead_info:s,marketing:{utm_source:localStorage.getItem("tj_utm_source"),utm_medium:localStorage.getItem("tj_utm_medium"),utm_campaign:localStorage.getItem("tj_utm_campaign"),utm_content:localStorage.getItem("tj_utm_content"),utm_term:localStorage.getItem("tj_utm_term"),gclid:localStorage.getItem("tj_gclid"),fbclid:localStorage.getItem("tj_fbclid"),ga_client_id:a.getGaId(),ga_session_id:a.getGaSession(),fbp:a.get("_fbp"),fbc:a.get("_fbc")},page_path:window.location.pathname,device_category:o()};e.track("form_submit",r),i("form_submit",{form_id:r.form_id||"(not set)",form_destination:r.action,page_path:window.location.pathname,device_category:o()})})),window.tjHub=e,console.log("✅ TJ Track Enhanced with GA4 Heatmap initialized",{site_id:e.site_id,session_id:e.session_id,ga4_available:n()})}();