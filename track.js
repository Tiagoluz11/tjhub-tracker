!function(){window.dataLayer=window.dataLayer||[];var e=window.tjHub||{};e.queue=e.queue||[];const t="https://tj-track-bd.tj-studio-ltda.workers.dev/get-tracking-data";function n(){return"undefined"!=typeof gtag}function o(e,t){if(n())try{gtag("event",e,{...t,send_to:"all",non_interaction:"scroll"===e||"vertical_scroll"===e})}catch(e){console.warn("GA4 tracking error:",e)}}function i(){const e=window.innerWidth;return e<=768?"mobile":e<=1024?"tablet":"desktop"}e.site_id=function(){const e=document.getElementsByTagName("script");for(let t of e)if(t.src.includes("site_id="))try{return new URL(t.src).searchParams.get("site_id")}catch(e){}return"TJTJS2025"}(),e.session_id=localStorage.getItem("tj_session_id")||`sess_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("tj_session_id",e.session_id);const a={get:e=>{const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null},getGaId:function(){const e=this.get("_ga");return e?e.replace(/^GA1\.\d\./,""):null},getGaSession:function(){const e=document.cookie.split(";");for(let t of e)if(t.trim().startsWith("_ga_")&&t.split(".").length>2)return t.split(".")[2];return null}};function c(){return{utm_source:localStorage.getItem("tj_utm_source"),utm_medium:localStorage.getItem("tj_utm_medium"),utm_campaign:localStorage.getItem("tj_utm_campaign"),utm_content:localStorage.getItem("tj_utm_content"),utm_term:localStorage.getItem("tj_utm_term"),gclid:localStorage.getItem("tj_gclid"),fbclid:localStorage.getItem("tj_fbclid"),ga_client_id:a.getGaId(),ga_session_id:a.getGaSession(),fbp:a.get("_fbp"),fbc:a.get("_fbc")}}!function(){const e=new URLSearchParams(window.location.search);["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid"].forEach(t=>{e.has(t)&&localStorage.setItem("tj_"+t,e.get(t))})}();let d=0,l=!1;window.addEventListener("scroll",function(){const e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)-window.innerHeight,t=e>0?Math.round(window.scrollY/e*100):0;t>d&&(d=t)},{passive:!0});function r(){if(!l){if(d>0){const s={max_scroll_depth:d,page_path:window.location.pathname,device_category:i()};e.track("scroll_depth_max",s),o("scroll_depth",{max_scroll_depth:d,page_path:window.location.pathname,device_category:i()})}l=!0}}document.addEventListener("visibilitychange",function(){if("hidden"===document.visibilityState)r()}),window.addEventListener("pagehide",r);function s(){if(e.sending&&(clearTimeout(e.sending),e.sending=null),e.queue.length>0){let n=e.queue.slice();e.queue=[];const o=JSON.stringify({events:n}),i=`${t}?site_id=${e.site_id}`;navigator.sendBeacon?navigator.sendBeacon(i,o):fetch(i,{method:"POST",body:o,keepalive:!1})}}window.addEventListener("pagehide",s),e.track=function(n,o={}){o.url=window.location.href,o.referrer=document.referrer,o.session_id=e.session_id,o.site_id=e.site_id,o.screen_size=`${window.innerWidth}x${window.innerHeight}`,o.device=navigator.userAgent,o.device_category=i(),o.timestamp=(new Date).toISOString(),e.queue.push({event:n,data:o}),e.sending||(e.sending=setTimeout(s,5e3))},e.track("page_view"),o("page_view",{page_path:window.location.pathname,page_title:document.title,device_category:i()}),document.addEventListener("click",function(t){const n=t.pageX,a=t.pageY,c=window.innerWidth,d=window.innerHeight,l=Math.round(t.clientX/c*100),r=Math.round(t.clientY/d*100),s=t.target.closest("a, button");if(!s){const n={click_x:t.pageX,click_y:t.pageY,click_x_percent:l,click_y_percent:r,page_path:window.location.pathname,target:t.target.tagName.toLowerCase(),class:t.target.className||"",id:t.target.id||"",device_category:i()};return e.track("heatmap_click",n),void o("heatmap_click",{click_x:t.pageX,click_y:t.pageY,page_path:window.location.pathname,element_id:t.target.id||"(not set)",element_class:t.target.className||"(not set)",device_category:i()})}let m={target:s.tagName.toLowerCase(),text:s.innerText?s.innerText.substring(0,50):"",class:s.className||"",id:s.id||"",href:s.href||"",click_x:n,click_y:a,click_x_percent:l,click_y_percent:r,page_path:window.location.pathname,device_category:i()};"a"===s.tagName.toLowerCase()&&s.hostname!==window.location.hostname?(m.external=!0,e.track("click_outbound",m),navigator.sendBeacon(`${t}?site_id=${e.site_id}`,JSON.stringify({events:[{event:"click_outbound",data:m}]})),o("click_outbound",{click_x:n,click_y:a,link_url:s.href,link_text:m.text,page_path:window.location.pathname,device_category:i()})):(e.track("click",m),o("click",{click_x:n,click_y:a,element_id:m.id||"(not set)",element_text:m.text,page_path:window.location.pathname,device_category:i()}))}),document.addEventListener("submit",function(t){const n=t.target;if(!n||"form"!==n.tagName.toLowerCase())return;if("true"!==n.getAttribute("data-track"))return;let a=new FormData(n),d={},l={nome:null,email:null,tel:null};for(let[e,t]of a.entries())if("string"!=typeof e||!e.toLowerCase().includes("senha")){d[e]=t;let n=e.toLowerCase();l.nome||!n.includes("nome")&&!n.includes("name")?!l.email&&n.includes("mail")?l.email=t:!l.tel&&(n.includes("tel")||n.includes("cel")||n.includes("whats"))&&(l.tel=t):l.nome=t}const r={tag:n.getAttribute("data-tag")||"Form Site",action:n.action||"",method:n.method||"GET",form_id:n.id||"",form_class:n.className||"",fields:d,lead_info:l,marketing:c(),page_path:window.location.pathname,device_category:i()};e.track("form_submit",r),o("form_submit",{form_id:r.form_id||"(not set)",form_destination:r.action,page_path:window.location.pathname,device_category:i()})}),window.tjHub=e,console.log("âœ… TJ Track Enhanced with GA4 Heatmap initialized",{site_id:e.site_id,session_id:e.session_id,ga4_available:n()})}();